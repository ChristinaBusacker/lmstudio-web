<div
  class="node"
  [class.preview]="isPreview()"
  [class.loop]="isLoopStart() || isLoopEnd()"
  [attr.data-node-type]="node().data.nodeType"
  (pointerdown)="onNodePointerDown($event)"
>
  @if (isMerge()) {
    @for (pid of mergePorts(); track pid; let i = $index) {
      <ng-diagram-port
        class="mergePort port-in"
        [id]="pid"
        side="left"
        type="target"
        originPoint="leftMiddle"
        [style.top.px]="mergePortTop(i)"
      >
        <div class="mergePortInner">
          <div class="mergePortDot" aria-hidden="true"></div>
          <div class="mergePortBadge">{{ getPortIndexLabel(pid) }}</div>
        </div>
      </ng-diagram-port>
    }

    <ng-diagram-port
      class="mergeOutPort"
      [id]="MERGE_OUT_PORT"
      side="right"
      type="source"
      originPoint="rightMiddle"
      [style.top.px]="mergeOutPortTop()"
    >
      <div class="mergePortInner mergeOutInner">
        <div class="mergePortDot" aria-hidden="true"></div>
        <div class="mergePortBadge">out</div>
      </div>
    </ng-diagram-port>
  } @else if (isCondition()) {
    <ng-diagram-port id="port-left" side="left" type="target"></ng-diagram-port>

    <ng-diagram-port
      class="condOutPort condTrue"
      [id]="CONDITION_TRUE_PORT"
      side="right"
      type="source"
      originPoint="rightMiddle"
      [style.top.px]="conditionTruePortTop()"
    >
      <div class="condPortInner">
        <div class="condPortDot" aria-hidden="true"></div>
        <div class="condPortBadge">true</div>
      </div>
    </ng-diagram-port>

    <ng-diagram-port
      class="condOutPort condFalse"
      [id]="CONDITION_FALSE_PORT"
      side="right"
      type="source"
      originPoint="rightMiddle"
      [style.top.px]="conditionFalsePortTop()"
    >
      <div class="condPortInner">
        <div class="condPortDot" aria-hidden="true"></div>
        <div class="condPortBadge">false</div>
      </div>
    </ng-diagram-port>
  } @else if (isExport() || isPreview()) {
    <ng-diagram-port id="port-left" side="left" type="target"></ng-diagram-port>
  } @else if (isLoopStart() || isLoopEnd()) {
    <ng-diagram-port id="port-left" side="left" type="target"></ng-diagram-port>
    <ng-diagram-port id="port-right" side="right" type="source"></ng-diagram-port>
  } @else {
    <ng-diagram-port id="port-left" side="left" type="both"></ng-diagram-port>
    <ng-diagram-port id="port-right" side="right" type="both"></ng-diagram-port>
  }

  <div class="header">
    <div class="title">{{ title() }}</div>
    <div class="sub">{{ node().data.nodeType }}</div>
  </div>

  <div class="body">
    <label class="field">
      <div class="label">Node Type</div>
      <select
        class="config input"
        [value]="node().data.nodeType"
        (change)="updateNodeType($event.target.value)"
      >
        <option [value]="NODE_LLM">lmstudio.llm</option>
        <option [value]="NODE_MERGE">workflow.merge</option>
        <option [value]="NODE_EXPORT">workflow.export</option>
        <option [value]="NODE_PREVIEW">ui.preview</option>
        <option [value]="NODE_CONDITION">workflow.condition</option>
        <option [value]="NODE_LOOP_START">workflow.loopStart</option>
        <option [value]="NODE_LOOP_END">workflow.loopEnd</option>
      </select>
    </label>

    @if (isLlm() || isCondition() || isLoopStart()) {
      <label class="field">
        <div class="label">Profile</div>
        <select
          class="config input"
          [value]="node().data.profileName"
          (change)="updateProfileName($event.target.value)"
          title="Visit settings to define presets"
        >
          <option value="">Default</option>
          @for (profile of profiles$ | async; track $index) {
            <option [value]="profile.name" [selected]="profile.name === node().data.profileName">
              {{ profile.name }}
            </option>
          }
        </select>
      </label>

      @if (isLlm() || isCondition()) {
        <label class="field">
          <div class="label">Prompt</div>
          <textarea
            class="textarea"
            rows="5"
            [value]="node().data.prompt"
            (input)="promptInput$.next($any($event.target).value)"
            placeholder="Prompt for this step..."
          ></textarea>
        </label>
      }
    }

    @if (isMerge()) {
      <label class="field">
        <div class="label">Separator</div>
        <textarea
          class="textarea"
          rows="2"
          [value]="node().data.mergeSeparator ?? '\n\n'"
          (input)="updateMergeSeparator($any($event.target).value)"
          placeholder="\n\n"
        ></textarea>
      </label>

      <div class="hint">
        Inputs are merged in port order (in-1, in-2, â€¦). One free input is always available.
      </div>
    }

    @if (isExport()) {
      <label class="field">
        <div class="label">Filename</div>
        <input
          class="input"
          type="text"
          [value]="node().data.exportFilename ?? 'export.txt'"
          (input)="updateExportFilename($any($event.target).value)"
          placeholder="export.txt"
        />
      </label>

      <div class="hint">Creates a text artifact for the current run.</div>
    }

    @if (isPreview()) {
      <label class="field">
        <div class="label">Max lines</div>
        <input
          class="input"
          type="number"
          min="3"
          max="50"
          [value]="node().data.previewMaxLines ?? 10"
          (input)="updatePreviewMaxLines(Number($any($event.target).value))"
        />
      </label>

      <div class="preview">
        @let details = selectedRunDetails$ | async;
        <pre class="previewText">{{ getPreviewText(details) }}</pre>
      </div>

      <div class="hint">Shows output of the connected upstream node for the selected run.</div>
    }

    @if (isLoopStart()) {
      <label class="field">
        <div class="label">Profile</div>
        <select
          class="config input"
          [value]="node().data.profileName"
          (change)="updateProfileName($event.target.value)"
          title="Visit settings to define presets"
        >
          <option value="">Default</option>
          @for (profile of profiles$ | async; track $index) {
            <option [value]="profile.name" [selected]="profile.name === node().data.profileName">
              {{ profile.name }}
            </option>
          }
        </select>
      </label>

      <label class="field">
        <div class="label">Loop mode</div>
        <select
          class="config input"
          [value]="node().data.loopMode ?? 'until'"
          (change)="updateLoopMode($any($event.target).value)"
        >
          <option value="until">Until condition is true</option>
          <option value="while">While condition is true</option>
        </select>
      </label>

      <label class="field">
        <div class="label">Max iterations</div>
        <input
          class="input"
          type="number"
          min="1"
          max="1000"
          [value]="node().data.loopMaxIterations ?? 10"
          (input)="updateLoopMaxIterations(Number($any($event.target).value))"
        />
      </label>

      <label class="field">
        <div class="label">Joiner</div>
        <textarea
          class="textarea"
          rows="2"
          [value]="node().data.loopJoiner ?? '\n\n'"
          (input)="updateLoopJoiner($any($event.target).value)"
          placeholder="\n\n"
        ></textarea>
      </label>

      <label class="field">
        <div class="label">Condition prompt</div>
        <textarea
          class="textarea"
          rows="4"
          [value]="node().data.loopConditionPrompt ?? ''"
          (input)="updateLoopConditionPrompt($any($event.target).value)"
          placeholder="E.g. Are all chapters fully written?"
        ></textarea>
      </label>

      <div class="hint">
        Inside loop body prompts you can use <code>{{ '{{loop.index}}' }}</code> (0-based) and
        <code>{{ '{{loop.iteration}}' }}</code> (1-based). Short aliases
        <code>{{ '{{index}}' }}</code> / <code>{{ '{{iteration}}' }}</code> work too.
      </div>
    }

    <ng-diagram-node-resize-adornment />
  </div>

  <div class="controls">
    <div class="controls">
      @if (canRerunFromHere()) {
        <button (click)="rerunFromHere()">
          <app-icon name="restart-line" title="rerun from here" />
        </button>
      }
      <button (click)="duplicateNode()">
        <app-icon name="file-copy-line" title="duplicate" />
      </button>
      <button (click)="deleteNode()">
        <app-icon name="delete-bin-line" title="delete" />
      </button>
      <button (click)="addLinkedNode()">
        <app-icon name="add-line" title="add connected node" />
      </button>
    </div>
  </div>
</div>
